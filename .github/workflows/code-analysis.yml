name: Code Analysis

on:
  # pull_request:
  #   branches: [main, master]
  workflow_dispatch:
    inputs:
      subfolder:
        description: "Subfolder path to scan (e.g. container_security)"
        required: true
        type: string

jobs:
  validate:
    runs-on: ubuntu-latest
    outputs:
      file_count: ${{ steps.validation.outputs.file_count }}
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate Subfolder
        id: validation
        run: |
          if [ ! -d "${{ github.event.inputs.subfolder }}" ]; then
            echo "Error: Subfolder '${{ github.event.inputs.subfolder }}' does not exist in the repository"
            exit 1
          fi

          # Count files in subfolder to ensure it's not empty
          file_count=$(find "${{ github.event.inputs.subfolder }}" -type f | wc -l)
          if [ "$file_count" -eq 0 ]; then
            echo "Error: Subfolder '${{ github.event.inputs.subfolder }}' exists but contains no files"
            exit 1
          fi

          echo "file_count=$file_count" >> "$GITHUB_OUTPUT"
          echo "Found $file_count files in ${{ github.event.inputs.subfolder }}"

  sonarqube:
    needs: validate
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      security-events: write
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: SonarQube Scan
        uses: sonarsource/sonarqube-scan-action@v6.0.0
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
        with:
          args: >
            -Dsonar.projectKey=AutoTriage
            -Dsonar.sources=.
            -Dsonar.inclusions=${{ github.event.inputs.subfolder }}/**/*
            -Dsonar.scm.provider=git

      - name: Wait for Analysis and Generate Report
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
        run: |
          # Wait for analysis to complete (check every 10 seconds, timeout after 5 minutes)
          for i in {1..30}; do
            status=$(curl -s -u ${SONAR_TOKEN}: "${SONAR_HOST_URL}/api/qualitygates/project_status?projectKey=AutoTriage" | jq -r '.projectStatus.status')
            
            if [ "$status" != "null" ]; then
              echo "Analysis completed with status: $status"
              break
            fi
            
            if [ $i -eq 30 ]; then
              echo "Timeout waiting for analysis to complete"
              exit 1
            fi
            
            echo "Waiting for analysis to complete... (attempt $i/30)"
            sleep 10
          done

          # Get analysis results
          curl -s -u ${SONAR_TOKEN}: "${SONAR_HOST_URL}/api/issues/search?componentKeys=AutoTriage&types=BUG,VULNERABILITY,CODE_SMELL" > sonar-issues.json
          curl -s -u ${SONAR_TOKEN}: "${SONAR_HOST_URL}/api/measures/component?component=AutoTriage&metricKeys=bugs,vulnerabilities,code_smells,coverage,duplicated_lines_density" > sonar-metrics.json

          # Create human-readable report
          echo "SonarQube Analysis Report for ${{ github.event.inputs.subfolder }}" > sonar-analysis-report.md
          echo "Generated on $(date)" >> sonar-analysis-report.md
          echo "---" >> sonar-analysis-report.md
          echo "## Quality Gate Status: $status" >> sonar-analysis-report.md
          echo "## Issues" >> sonar-analysis-report.md
          jq -r '.issues[] | "* " + .severity + ": " + .message + " (" + .component + ":" + (.line|tostring) + ")"' sonar-issues.json >> sonar-analysis-report.md || echo "No issues found" >> sonar-analysis-report.md
          echo "## Metrics" >> sonar-analysis-report.md
          jq -r '.component.measures[] | .metric + ": " + .value' sonar-metrics.json >> sonar-analysis-report.md || echo "No metrics available" >> sonar-analysis-report.md

      - name: Upload SonarQube Reports
        uses: actions/upload-artifact@v4
        with:
          name: sonarqube-analysis-${{ github.event.inputs.subfolder }}
          path: |
            sonar-issues.json
            sonar-metrics.json
            sonar-analysis-report.md

  dependency-check:
    needs: validate
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Dependency Check
        uses: dependency-check/Dependency-Check_Action@main
        env:
          JAVA_HOME: /opt/jdk
        with:
          project: ${{ github.event.inputs.subfolder }}
          path: ${{ github.event.inputs.subfolder }}
          format: "JSON"
          out: "reports"
          args: >
            --enableRetired
            --enableExperimental
            --scan ${{ github.event.inputs.subfolder }}/**/*
            --prettyPrint
            --exclude "**/test/**" "**/tests/**"
            --log "reports/dependency-check.log"

      - name: Upload Dependency Check Report
        uses: actions/upload-artifact@v4
        with:
          name: dependency-check-${{ github.event.inputs.subfolder }}
          path: reports/dependency-check-report.json

  generate-sbom:
    needs: validate
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate CycloneDX SBOM
        uses: CycloneDX/gh-node-module-generatebom@v1
        with:
          path: ${{ github.event.inputs.subfolder }}
          output: ${{ github.event.inputs.subfolder }}-sbom.json

      - name: Upload SBOM
        uses: actions/upload-artifact@v4
        with:
          name: sbom-${{ github.event.inputs.subfolder }}
          path: ${{ github.event.inputs.subfolder }}-sbom.json

  # aggregate-analysis:
  #   needs: [sonarqube, dependency-check, generate-sbom]
  #   runs-on: ubuntu-latest
  #   steps:
  #     - name: Checkout repo
  #       uses: actions/checkout@v4
  #       with:
  #         fetch-depth: 0

  #     - name: Set up Python
  #       uses: actions/setup-python@v5
  #       with:
  #         python-version: "3.x"

  #     - name: Install dependencies
  #       run: |
  #         python -m pip install --upgrade pip
  #         pip install setuptools requests

  #     - name: Download SonarQube Analysis
  #       uses: actions/download-artifact@v4
  #       with:
  #         name: sonarqube-analysis-${{ github.event.inputs.subfolder }}
  #         path: analysis-inputs/sonarqube

  #     - name: Download Dependency Check Results
  #       uses: actions/download-artifact@v4
  #       with:
  #         name: dependency-check-${{ github.event.inputs.subfolder }}
  #         path: analysis-inputs/dependency-check

  #     - name: Download SBOM
  #       uses: actions/download-artifact@v4
  #       with:
  #         name: sbom-${{ github.event.inputs.subfolder }}
  #         path: analysis-inputs/sbom

  #     - name: Run Analysis Aggregation
  #       id: analyze
  #       run: python scripts/analyze_dependencies.py ${{ github.event.inputs.subfolder }}

  #     - name: Upload Aggregated Analysis
  #       uses: actions/upload-artifact@v4
  #       with:
  #         name: aggregated-analysis-${{ github.event.inputs.subfolder }}
  #         path: analysis-outputs/
