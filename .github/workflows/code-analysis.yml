name: Code Analysis

on:
  # pull_request:
  #   branches: [main, master]
  workflow_dispatch:
    inputs:
      subfolder:
        description: "Subfolder path to scan (default: repo root)"
        required: false
        type: string
        default: "."
      max_iterations:
        description: "Maximum tool calls AI can make per issue (default: 15)"
        required: false
        type: number
        default: 15

jobs:
  validate:
    runs-on: ubuntu-latest
    outputs:
      file_count: ${{ steps.validation.outputs.file_count }}
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate Subfolder
        id: validation
        run: |
          SUBFOLDER="${{ github.event.inputs.subfolder || '.' }}"

          if [ ! -d "$SUBFOLDER" ]; then
            echo "Error: Path '$SUBFOLDER' does not exist in the repository"
            exit 1
          fi

          # Count files (excluding _AutoTriageScripts)
          file_count=$(find "$SUBFOLDER" -type f ! -path "*/_AutoTriageScripts/*" | wc -l)
          if [ "$file_count" -eq 0 ]; then
            echo "Error: Path '$SUBFOLDER' exists but contains no files"
            exit 1
          fi

          echo "file_count=$file_count" >> "$GITHUB_OUTPUT"
          echo "Analyzing $file_count files in $SUBFOLDER"

  sonarqube:
    needs: validate
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      security-events: write
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: SonarQube Scan
        uses: sonarsource/sonarqube-scan-action@v6.0.0
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
          SUBFOLDER: ${{ github.event.inputs.subfolder || '.' }}
        with:
          args: >
            -Dsonar.projectKey=${{ github.event.repository.name }}-${{ github.event.inputs.subfolder == '.' && 'root' || github.event.inputs.subfolder }}
            -Dsonar.sources=${{ github.event.inputs.subfolder == '.' && '.' || github.event.inputs.subfolder }}
            -Dsonar.exclusions=_AutoTriageScripts/**
            -Dsonar.scm.provider=git

      - name: Wait for Analysis and Generate Report
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
        run: |
          SUBFOLDER="${{ github.event.inputs.subfolder || '.' }}"
          if [ "$SUBFOLDER" == "." ]; then
            PROJECT_KEY="${{ github.event.repository.name }}-root"
          else
            PROJECT_KEY="${{ github.event.repository.name }}-${SUBFOLDER}"
          fi
          echo "Using SonarQube project key: $PROJECT_KEY"

          # Get the task ID from the scanner's report file (created at repo root)
          if [ ! -f ".scannerwork/report-task.txt" ]; then
            echo "Error: report-task.txt not found. SonarQube scan may have failed."
            echo "Looking in: $(pwd)/.scannerwork/"
            ls -la .scannerwork/ 2>/dev/null || echo "Directory .scannerwork/ does not exist"
            exit 1
          fi

          TASK_ID=$(grep "ceTaskId=" .scannerwork/report-task.txt | cut -d'=' -f2)
          echo "SonarQube Task ID: $TASK_ID"

          if [ -z "$TASK_ID" ]; then
            echo "Error: Could not extract task ID from report-task.txt"
            exit 1
          fi

          # Poll the Compute Engine task status until complete
          echo "Waiting for SonarQube background task to complete..."
          MAX_ATTEMPTS=60
          SLEEP_SECONDS=10

          for i in $(seq 1 $MAX_ATTEMPTS); do
            TASK_STATUS=$(curl -s -u ${SONAR_TOKEN}: "${SONAR_HOST_URL}/api/ce/task?id=${TASK_ID}" | jq -r '.task.status')
            
            echo "Attempt $i/$MAX_ATTEMPTS - Task status: $TASK_STATUS"
            
            if [ "$TASK_STATUS" == "SUCCESS" ]; then
              echo "Analysis completed successfully!"
              break
            elif [ "$TASK_STATUS" == "FAILED" ] || [ "$TASK_STATUS" == "CANCELED" ]; then
              echo "Error: Analysis task failed with status: $TASK_STATUS"
              curl -s -u ${SONAR_TOKEN}: "${SONAR_HOST_URL}/api/ce/task?id=${TASK_ID}" | jq '.task'
              exit 1
            elif [ "$TASK_STATUS" == "PENDING" ] || [ "$TASK_STATUS" == "IN_PROGRESS" ]; then
              if [ $i -eq $MAX_ATTEMPTS ]; then
                echo "Timeout: Analysis did not complete within $(($MAX_ATTEMPTS * $SLEEP_SECONDS)) seconds"
                exit 1
              fi
              sleep $SLEEP_SECONDS
            else
              echo "Warning: Unknown task status: $TASK_STATUS"
              sleep $SLEEP_SECONDS
            fi
          done

          # Now that analysis is complete, fetch the results
          echo "Fetching analysis results..."

          # Get analysis results - issues and security hotspots use different APIs
          curl -s -u ${SONAR_TOKEN}: "${SONAR_HOST_URL}/api/issues/search?componentKeys=${PROJECT_KEY}&types=BUG,VULNERABILITY,CODE_SMELL" > sonar-issues.json
          curl -s -u ${SONAR_TOKEN}: "${SONAR_HOST_URL}/api/hotspots/search?projectKey=${PROJECT_KEY}" > sonar-hotspots.json
          curl -s -u ${SONAR_TOKEN}: "${SONAR_HOST_URL}/api/measures/component?component=${PROJECT_KEY}&metricKeys=bugs,vulnerabilities,code_smells,security_hotspots,coverage,duplicated_lines_density" > sonar-metrics.json

          # Get Quality Gate status
          QG_STATUS=$(curl -s -u ${SONAR_TOKEN}: "${SONAR_HOST_URL}/api/qualitygates/project_status?projectKey=${PROJECT_KEY}" | jq -r '.projectStatus.status')

          # Create human-readable report
          echo "SonarQube Analysis Report for ${{ github.event.inputs.subfolder }}" > sonar-analysis-report.md
          echo "Generated on $(date)" >> sonar-analysis-report.md
          echo "---" >> sonar-analysis-report.md
          echo "## Quality Gate Status: $QG_STATUS" >> sonar-analysis-report.md
          echo "## Issues" >> sonar-analysis-report.md
          jq -r '.issues[] | "* " + .severity + ": " + .message + " (" + .component + ":" + (.line|tostring) + ")"' sonar-issues.json >> sonar-analysis-report.md || echo "No issues found" >> sonar-analysis-report.md
          echo "## Metrics" >> sonar-analysis-report.md
          jq -r '.component.measures[] | .metric + ": " + .value' sonar-metrics.json >> sonar-analysis-report.md || echo "No metrics available" >> sonar-analysis-report.md

      - name: Upload SonarQube Reports
        uses: actions/upload-artifact@v4
        with:
          name: sonarqube-analysis
          path: |
            sonar-issues.json
            sonar-hotspots.json
            sonar-metrics.json
            sonar-analysis-report.md

  dependency-check:
    needs: validate
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Dependency Check
        uses: dependency-check/Dependency-Check_Action@main
        env:
          JAVA_HOME: /opt/jdk
        with:
          project: ${{ github.event.repository.name }}
          path: ${{ github.event.inputs.subfolder || '.' }}
          format: "JSON"
          out: "reports"
          args: >
            --enableRetired
            --enableExperimental
            --prettyPrint
            --scan "${{ github.event.inputs.subfolder || '.' }}"
            --exclude "**/test/**" "**/tests/**" "**/_AutoTriageScripts/**"
            --log "reports/dependency-check.log"

      - name: Upload Dependency Check Report
        uses: actions/upload-artifact@v4
        with:
          name: dependency-check
          path: reports/dependency-check-report.json

  generate-sbom:
    needs: validate
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Syft (Universal SBOM Generator)
        run: |
          curl -sSfL https://raw.githubusercontent.com/anchore/syft/main/install.sh | sh -s -- -b /usr/local/bin

      - name: Generate CycloneDX SBOM with Syft
        run: |
          SCAN_PATH="${{ github.event.inputs.subfolder || '.' }}"

          echo "Generating SBOM for $SCAN_PATH using Syft..."
          echo "Syft will auto-detect: Python, JavaScript, Java, Go, Ruby, PHP, and more!"

          # Exclude _AutoTriageScripts directory (Syft requires ./ or **/ prefix)
          syft dir:$SCAN_PATH -o cyclonedx-json --exclude '**/_AutoTriageScripts/**' > sbom.json

          # Show what was detected
          echo ""
          echo "=== SBOM Summary ==="
          jq '.components | length' sbom.json 2>/dev/null || echo "0"
          echo "components detected"

          # List detected package managers
          echo ""
          echo "=== Package Ecosystems Detected ==="
          jq -r '.components[]? | .purl // "unknown" | split(":")[0] // "unknown"' sbom.json 2>/dev/null | sort -u || echo "None"

      - name: Upload SBOM
        uses: actions/upload-artifact@v4
        with:
          name: sbom
          path: sbom.json

  aggregate-analysis:
    needs: [sonarqube, dependency-check, generate-sbom]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r _AutoTriageScripts/requirements.txt

      - name: Download SonarQube Analysis
        uses: actions/download-artifact@v4
        with:
          name: sonarqube-analysis
          path: analysis-inputs/sonarqube

      - name: Download Dependency Check Results
        uses: actions/download-artifact@v4
        with:
          name: dependency-check
          path: analysis-inputs/dependency-check

      - name: Download SBOM
        uses: actions/download-artifact@v4
        with:
          name: sbom
          path: analysis-inputs/sbom

      - name: Run Analysis Aggregation
        id: analyze
        env:
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
        run: python _AutoTriageScripts/analyze_dependencies.py ${{ github.event.inputs.subfolder || '.' }} --sonarqube --dependency-check --sbom --max-iterations ${{ github.event.inputs.max_iterations || 15 }}

      - name: Upload Aggregated Analysis
        uses: actions/upload-artifact@v4
        with:
          name: aggregated-analysis
          path: analysis-outputs/
