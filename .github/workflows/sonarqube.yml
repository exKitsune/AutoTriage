name: SonarQube Analysis

on:
  # pull_request:
  #   branches: [main, master]
  workflow_dispatch:
    inputs:
      subfolder:
        description: "Subfolder path to scan (e.g. container_security)"
        required: true
        type: string

jobs:
  scan_code:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      security-events: write
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate Subfolder
        run: |
          if [ ! -d "${{ github.event.inputs.subfolder }}" ]; then
            echo "Error: Subfolder '${{ github.event.inputs.subfolder }}' does not exist in the repository"
            exit 1
          fi

          # Count files in subfolder to ensure it's not empty
          file_count=$(find "${{ github.event.inputs.subfolder }}" -type f | wc -l)
          if [ "$file_count" -eq 0 ]; then
            echo "Error: Subfolder '${{ github.event.inputs.subfolder }}' exists but contains no files"
            exit 1
          fi

          echo "Found $file_count files in ${{ github.event.inputs.subfolder }}"

      - name: SonarQube Scan
        uses: sonarsource/sonarqube-scan-action@v6.0.0
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
        with:
          args: >
            -Dsonar.projectKey=AutoTriage
            -Dsonar.sources=.
            -Dsonar.inclusions=${{ github.event.inputs.subfolder }}/**/*
            -Dsonar.scm.provider=git

      - name: Wait for Analysis and Generate Report
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
        run: |
          # Wait for analysis to complete (check every 10 seconds, timeout after 5 minutes)
          for i in {1..30}; do
            status=$(curl -s -u ${SONAR_TOKEN}: "${SONAR_HOST_URL}/api/qualitygates/project_status?projectKey=AutoTriage" | jq -r '.projectStatus.status')
            
            if [ "$status" != "null" ]; then
              echo "Analysis completed with status: $status"
              break
            fi
            
            if [ $i -eq 30 ]; then
              echo "Timeout waiting for analysis to complete"
              exit 1
            fi
            
            echo "Waiting for analysis to complete... (attempt $i/30)"
            sleep 10
          done

          # Get analysis results
          curl -s -u ${SONAR_TOKEN}: "${SONAR_HOST_URL}/api/issues/search?componentKeys=AutoTriage&types=BUG,VULNERABILITY,CODE_SMELL" > sonar-issues.json
          curl -s -u ${SONAR_TOKEN}: "${SONAR_HOST_URL}/api/measures/component?component=AutoTriage&metricKeys=bugs,vulnerabilities,code_smells,coverage,duplicated_lines_density" > sonar-metrics.json

          # Create human-readable report
          echo "SonarQube Analysis Report for ${{ github.event.inputs.subfolder }}" > sonar-analysis-report.md
          echo "Generated on $(date)" >> sonar-analysis-report.md
          echo "---" >> sonar-analysis-report.md
          echo "## Quality Gate Status: $status" >> sonar-analysis-report.md
          echo "## Issues" >> sonar-analysis-report.md
          jq -r '.issues[] | "* " + .severity + ": " + .message + " (" + .component + ":" + (.line|tostring) + ")"' sonar-issues.json >> sonar-analysis-report.md || echo "No issues found" >> sonar-analysis-report.md
          echo "## Metrics" >> sonar-analysis-report.md
          jq -r '.component.measures[] | .metric + ": " + .value' sonar-metrics.json >> sonar-analysis-report.md || echo "No metrics available" >> sonar-analysis-report.md

      - name: Upload Analysis Reports
        uses: actions/upload-artifact@v4
        with:
          name: sonarqube-analysis-${{ github.event.inputs.subfolder }}
          path: |
            sonar-issues.json
            sonar-metrics.json
            sonar-analysis-report.md
